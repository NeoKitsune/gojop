package gojop

import (
	"fmt"
	"net"
)

var (
	data []byte
	err  error
)

type SimEnv struct {
	Conn net.Conn
}

func (s *SimEnv) Connect(host string, port uint16) bool {
	if s.Conn != nil {
		return true
	}

	addr := fmt.Sprintf("%s:%d", host, port)
	s.Conn, err = net.Dial("tcp", addr)
	if err != nil {
		fmt.Println(err)
		s.Conn = nil
		return false
	}
	go func() {
		data = make([]byte, 2048)
		for {
			if s.Conn == nil {
				break
			}
			n, err := s.Conn.Read(data)
			if err != nil {
				fmt.Println(err)
				break
			}
			if n > 0 {
				fmt.Printf("Server: %s\n", string(data[:n]))
			}
		}
	}()

	return true
}

/*
49 68 67 1c 00 00 00 00  00 00 00 00 01 00 00 00   Ihg..... ........
01 00 00 00 01 53 69 6d  45 6e 76 4d 61 6e 61 67   .....Sim EnvManag
65 72 2e 43 75 72 72 65  6e 74 2e 52 65 73 65 74   er.Curre nt.Reset
53 69 6d 45 6e 76 4e 6f  53 74 6f 70 20 20 20 20   SimEnvNo Stop
20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20
20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20
20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20
20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20
20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20
20 20 20 20 20
*/
var reset = []byte{ /* Packet 1648 */
	0x49, 0x68, 0x67, 0x1c, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
	0x01, 0x00, 0x00, 0x00, 0x01, 0x53, 0x69, 0x6d,
	0x45, 0x6e, 0x76, 0x4d, 0x61, 0x6e, 0x61, 0x67,
	0x65, 0x72, 0x2e, 0x43, 0x75, 0x72, 0x72, 0x65,
	0x6e, 0x74, 0x2e, 0x52, 0x65, 0x73, 0x65, 0x74,
	0x53, 0x69, 0x6d, 0x45, 0x6e, 0x76, 0x4e, 0x6f,
	0x53, 0x74, 0x6f, 0x70, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20}

func (s *SimEnv) Send(str string) {
	if s.Conn != nil {
		//magic := []byte{0x49, 0x68, 0x67, 0x1c, 0x0, 0x0, 0x0}
		tmp := append(reset[:21], []byte(str)...)
		for i := 0; i <= 92; i++ {
			tmp = append(tmp, 0x20)
		}
		s.Conn.Write(tmp)
		fmt.Printf("len:%d\n%x", len(tmp), tmp)
	}
}
